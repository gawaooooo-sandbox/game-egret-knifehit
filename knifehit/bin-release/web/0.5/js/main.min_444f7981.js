var __reflect=this&&this.__reflect||function(t,e,n){t.__class__=e,n?n.push(e):n=[e],t.__types__=t.__types__?n.concat(t.__types__):n},__extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);n.prototype=e.prototype,t.prototype=new n},__awaiter=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,a){function o(t){try{h(i.next(t))}catch(e){a(e)}}function s(t){try{h(i["throw"](t))}catch(e){a(e)}}function h(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(o,s)}h((i=i.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function n(t){return function(e){return i([t,e])}}function i(n){if(r)throw new TypeError("Generator is already executing.");for(;h;)try{if(r=1,a&&(o=a[2&n[0]?"return":n[0]?"throw":"next"])&&!(o=o.call(a,n[1])).done)return o;switch(a=0,o&&(n=[0,o.value]),n[0]){case 0:case 1:o=n;break;case 4:return h.label++,{value:n[1],done:!1};case 5:h.label++,a=n[1],n=[0];continue;case 7:n=h.ops.pop(),h.trys.pop();continue;default:if(o=h.trys,!(o=o.length>0&&o[o.length-1])&&(6===n[0]||2===n[0])){h=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){h.label=n[1];break}if(6===n[0]&&h.label<o[1]){h.label=o[1],o=n;break}if(o&&h.label<o[2]){h.label=o[2],h.ops.push(n);break}o[2]&&h.ops.pop(),h.trys.pop();continue}n=e.call(t,h)}catch(i){n=[6,i],a=0}finally{r=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var r,a,o,s,h={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},BitMapBase=function(t){function e(e){var n=t.call(this)||this;return n.name=e,n.createBitmapByName(),n}return __extends(e,t),e.prototype.createBitmapByName=function(){if(this.name){var t=RES.getRes(this.name);return this.texture=t,this}},e}(egret.Bitmap);__reflect(BitMapBase.prototype,"BitMapBase");var Knife=function(t){function e(n,i,r){var a=t.call(this,e.PNG_NAME)||this;return a.stageWidth=n,a.stageHeight=i,a.target=r,a}return __extends(e,t),e.STEP_ROT=3,e.PNG_NAME="knife_png",e}(BitMapBase);__reflect(Knife.prototype,"Knife");var HitKnife=function(t){function e(e){var n=e.stageWidth,i=e.stageHeight,r=e.target,a=e.x,o=e.y,s=e.impactAngle,h=t.call(this,n,i,r)||this;return h.impactAngle=s,h.target=r,h.setOption({x:a,y:o}),h.launchAnimation(),h}return __extends(e,t),e.prototype.setOption=function(t){var e=t.x,n=t.y;this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2,this.x=e,this.y=n},e.prototype.launchAnimation=function(){var t=this;this.addEventListener(egret.Event.ENTER_FRAME,function(n){t.rotation+=e.STEP_ROT;var i=(t.rotation+90)*Math.PI/180;return t.x=t.target.x+t.target.width/2*Math.cos(i),t.y=t.target.y+t.target.width/2*Math.sin(i),!1},this)},e.prototype.getImpactAngle=function(){return this.impactAngle},e}(Knife);__reflect(HitKnife.prototype,"HitKnife");var KnifeManager=function(){function t(t,e,n,i){this.hitKnifes=[],this.isLegalHit=!1,this.stageWidth=t,this.stageHeight=e,this.target=n,this.mainDispatcher=i;var r=new KnifeManagerDispatcher;r.addEventListener(KnifeManagerDispatcher.HIT,this.hit,this),this.throwKnife=new ThrowKnife(t,e,n,r)}return t.prototype.getThrowKnifeInstance=function(){return this.throwKnife},t.prototype.hit=function(t){this.isLegalHit=!0;for(var e=t.data+180,n={x:this.throwKnife.x,y:this.throwKnife.y},i=n.x,r=n.y,a=0;a<this.hitKnifes.length;a+=1){var o=this.hitKnifes[a];if(Math.abs(e-o.getImpactAngle())<15){this.gameOver();break}}if(this.isLegalHit){var o=new HitKnife({stageWidth:this.stageWidth,stageHeight:this.stageHeight,target:this.target,x:i,y:r,impactAngle:e});this.afterHit(o)}},t.prototype.afterHit=function(t){this.hitKnifes.push(t),this.mainDispatcher.add(t),this.throwKnife.reset()},t.prototype.gameOver=function(){console.log(" !! GAME OVER !!! "),this.isLegalHit=!1,this.throwKnife.fallOut(),this.mainDispatcher.removeAll(this.hitKnifes),this.hitKnifes=[]},t}();__reflect(KnifeManager.prototype,"KnifeManager");var KnifeManagerDispatcher=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.doHit=function(t){this.dispatchEventWith(e.HIT,!1,t)},e.HIT="hit",e}(egret.EventDispatcher);__reflect(KnifeManagerDispatcher.prototype,"KnifeManagerDispatcher");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){egret.log(" call loading UI createView "),this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e;var n=Math.round(t/e*100);egret.log("percentage: "+n),FBInstant.setLoadingProgress(n)},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){var e=t.call(this)||this;return e.once(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){var e=this;egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){console.log("egret onPause"),egret.ticker.pause()},egret.lifecycle.onResume=function(){console.log("egret onResume"),egret.ticker.resume()},console.log(FBInstant),FBInstant.initializeAsync().then(function(){var t=FBInstant.getLocale(),n=FBInstant.getPlatform(),i=FBInstant.getSDKVersion(),r=FBInstant.player.getID();egret.log(" FB information : "),egret.log(t,n,i,r),e.runGame()["catch"](function(t){console.log(t)})})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return[4,this.loadResource()];case 1:return e.sent(),FBInstant.startGameAsync().then(function(){var e=FBInstant.context.getID(),n=FBInstant.context.getType(),i=FBInstant.player.getName(),r=FBInstant.player.getPhoto(),a=FBInstant.player.getID();egret.log("FBInstant startGameAsync"),egret.log(e,n,i,r,a),t.createGameScene(),t.launchAnimation()}),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return n.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return n.sent(),this.stage.removeChild(t),[3,4];case 3:return e=n.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.createGameScene=function(){var t=new MainDispatcher;t.addEventListener(MainDispatcher.ADD_KNIFE,this.addKnife,this),t.addEventListener(MainDispatcher.REMOVE_KNIFE,this.removeAllKnife,this);var e=this.stage.stageWidth,n=this.stage.stageHeight,i=new egret.Shape;i.graphics.beginFill(4473924),i.graphics.drawRect(0,0,e,n),i.graphics.endFill(),this.addChild(i),this.target=new Target(e,n);var r=new KnifeManager(e,n,this.target,t),a=r.getThrowKnifeInstance();this.addChildAt(a,1),this.addChildAt(this.target,2),this.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(t){a["throw"]()},this)},e.prototype.addKnife=function(t){if(t.data){var e=t.data;this.addChildAt(e,1)}},e.prototype.removeAllKnife=function(t){var e=this;if(t.data){var n=t.data;n.forEach(function(t){e.removeChild(t)})}},e.prototype.launchAnimation=function(){},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var MainDispatcher=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.add=function(t){this.dispatchEventWith(e.ADD_KNIFE,!1,t)},e.prototype.removeAll=function(t){this.dispatchEventWith(e.REMOVE_KNIFE,!1,t)},e.ADD_KNIFE="addknife",e.REMOVE_KNIFE="removeknife",e}(egret.EventDispatcher);__reflect(MainDispatcher.prototype,"MainDispatcher");var Target=function(t){function e(n,i){var r=t.call(this,e.PNG_NAME)||this;return r.stageWidth=n,r.stageHeight=i,r.setOption(),r.launchAnimation(),r}return __extends(e,t),e.prototype.setOption=function(){this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2,this.x=this.stageWidth/2,this.y=400},e.prototype.launchAnimation=function(){var t=this;this.addEventListener(egret.Event.ENTER_FRAME,function(n){return t.rotation+=e.STEP_ROT,!1},this)},e.STEP_ROT=3,e.PNG_NAME="target_png",e}(BitMapBase);__reflect(Target.prototype,"Target");var ThrowKnife=function(t){function e(e,n,i,r){var a=t.call(this,e,n,i)||this;return a.canThrow=!0,a.dispatcher=r,a.setOption(),a}return __extends(e,t),e.prototype.setOption=function(){this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2,this.x=this.stageWidth/2,this.y=this.stageHeight/5*4},e.prototype["throw"]=function(){return this.canThrow?(this.canThrow=!1,void egret.Tween.get(this,{}).to({y:this.target.y+this.height/2},e.THROW_SPEED).call(this.onThrowComplete,this)):void console.log(" can not throw knife")},e.prototype.onThrowComplete=function(){this.dispatcher.doHit(this.target.rotation)},e.prototype.reset=function(){this.canThrow=!0,this.setOption()},e.prototype.fallOut=function(){egret.Tween.get(this,{onChange:this.onFallOutChange,onChangeObj:this}).to({y:this.stageHeight+this.height,rotation:360},4*e.THROW_SPEED).call(this.onFallOutComplete,this)},e.prototype.onFallOutChange=function(){this.rotation+=e.FALLOUT_ROTATION},e.prototype.onFallOutComplete=function(){this.reset(),this.rotation-=e.FALLOUT_ROTATION},e.THROW_SPEED=150,e.FALLOUT_ROTATION=15,e}(Knife);__reflect(ThrowKnife.prototype,"ThrowKnife");